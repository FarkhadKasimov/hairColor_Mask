<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Hair Color Demo — MediaPipe (UMD + ESM fallback)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { margin:0; background:#0e0e10; color:#fff; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans"; }
    header { padding:12px 16px; display:flex; gap:12px; align-items:center; border-bottom:1px solid #1f1f22; }
    header h1 { font-size:16px; margin:0; font-weight:600; opacity:.9; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-left:auto; }
    .controls label { display:flex; align-items:center; gap:8px; font-size:14px; opacity:.9; }
    .controls input[type="color"] { width:36px; height:28px; border:0; background:transparent; }
    .controls input[type="range"] { width:160px; }
    main { display:grid; place-items:center; height:calc(100vh - 58px); padding:10px; }
    canvas { width:min(92vw, 960px); height:auto; background:#000; border-radius:14px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    button { background:#1f6feb; color:#fff; border:0; border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:600; }
    button:disabled { opacity:.5; cursor:default; }
    select { background:#151518; color:#fff; border:1px solid #2a2a31; border-radius:10px; padding:6px 10px; }
    .warn { font-size:12px; opacity:.75; margin-left:8px; }
  </style>
  <!-- 1) СТАБИЛЬНЫЙ UMD-бандл (без type="module") -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/vision_bundle.js" crossorigin="anonymous"></script>
</head>
<body>
  <header>
    <h1>Hair Color — MediaPipe (WebCam)</h1>
    <div class="controls">
      <label>Цвет <input id="color" type="color" value="#ff3366" /></label>
      <label>Интенсивность <input id="strength" type="range" min="0" max="1" step="0.01" value="0.85" /></label>
      <label>Смягчение <input id="feather" type="range" min="0" max="12" step="0.5" value="4" /></label>
      <label>Блендинг
        <select id="blend">
          <option value="color">color</option>
          <option value="soft-light">soft-light</option>
          <option value="multiply">multiply</option>
          <option value="overlay" selected>overlay</option>
          <option value="screen">screen</option>
        </select>
      </label>
      <button id="swap">Поменять камеру</button>
      <button id="snap">Сохранить кадр</button>
      <span class="warn" id="status"></span>
    </div>
  </header>

  <main>
    <canvas id="out" width="960" height="540"></canvas>
  </main>

  <video id="video" playsinline autoplay muted style="display:none"></video>
  <canvas id="mask" width="960" height="540" style="display:none"></canvas>

  <script>
    // === НАСТРОЙКА МОДЕЛИ ===
    // Вариант 1: локальный файл рядом со страницей:
    const MODEL_ASSET_PATH = "models/hair_segmentation.tflite";
    // Вариант 2: публичная ссылка (раскомментировать одну строку ниже, если хотите):
    // const MODEL_ASSET_PATH = "https://storage.googleapis.com/mediapipe-assets/hair_segmentation.tflite";

    const statusEl       = document.getElementById('status');
    const colorInput     = document.getElementById('color');
    const strengthInput  = document.getElementById('strength');
    const featherInput   = document.getElementById('feather');
    const blendSelect    = document.getElementById('blend');
    const snapBtn        = document.getElementById('snap');
    const swapBtn        = document.getElementById('swap');
    const video          = document.getElementById('video');
    const out            = document.getElementById('out');
    const maskCanvas     = document.getElementById('mask');
    const ctx            = out.getContext('2d');
    const mctx           = maskCanvas.getContext('2d', { willReadFrequently: true });

    let segmenter = null;
    let currentFacing = 'user'; // 'user' | 'environment'
    let stream = null;

    function setStatus(msg) { statusEl.textContent = msg || ''; }

    // Ждём, пока UMD положит глобалы в window; иначе подключим ESM-фолбэк
    function untilMPReady(timeout = 4000) {
      return new Promise((resolve, reject) => {
        const t0 = performance.now();
        (function tick() {
          if (window.FilesetResolver && window.ImageSegmenter) return resolve();
          if (performance.now() - t0 > timeout) return reject(new Error('UMD not ready'));
          requestAnimationFrame(tick);
        })();
      });
    }

    function hexToRgb(hex) {
      const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return m ? { r: parseInt(m[1],16), g: parseInt(m[2],16), b: parseInt(m[3],16) } : { r:255,g:0,b:0 };
    }

    function featherMask(radiusPx) {
      if (radiusPx <= 0) return;
      const { width, height } = maskCanvas;
      mctx.filter = `blur(${radiusPx}px)`;
      const img = mctx.getImageData(0, 0, width, height);
      mctx.clearRect(0, 0, width, height);
      mctx.putImageData(img, 0, 0);
      mctx.filter = 'none';
    }

    async function initCamera() {
      if (stream) stream.getTracks().forEach(t => t.stop());
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: currentFacing }, width: { ideal: 960 }, height: { ideal: 540 } },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
      resizeToVideo();
    }

    function resizeToVideo() {
      const w = video.videoWidth || 960;
      const h = video.videoHeight || 540;
      out.width = maskCanvas.width = w;
      out.height = maskCanvas.height = h;
    }

    async function initSegmenter() {
      const fileset = await window.FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/wasm"
      );
      segmenter = await window.ImageSegmenter.createFromOptions(fileset, {
        baseOptions: { modelAssetPath: MODEL_ASSET_PATH, delegate: "GPU" },
        runningMode: "VIDEO",
        outputCategoryMask: true,
        outputConfidenceMasks: false
      });
    }

    async function processFrame() {
      if (!segmenter || video.readyState < 2) {
        requestAnimationFrame(processFrame);
        return;
      }
      const { width, height } = out;

      // 1) Сегментация
      const result = await segmenter.segmentForVideo(video, performance.now());

      // 2) Базовый кадр камеры
      ctx.globalCompositeOperation = 'source-over';
      ctx.globalAlpha = 1;
      ctx.drawImage(video, 0, 0, width, height);

      // 3) Маска в maskCanvas
      mctx.clearRect(0, 0, width, height);
      let drawn = false;

      if (result.categoryMask && typeof result.categoryMask.drawToCanvas === 'function') {
        result.categoryMask.drawToCanvas(mctx);
        drawn = true;
      } else if (result.categoryMask && typeof result.categoryMask.getAsFloat32Array === 'function') {
        const arr = result.categoryMask.getAsFloat32Array();
        if (arr && arr.length >= width * height) {
          const imgData = mctx.createImageData(width, height);
          const d = imgData.data;
          for (let i = 0; i < width * height; i++) {
            const v = Math.max(0, Math.min(1, arr[i] || 0));
            const idx = i * 4;
            d[idx] = d[idx+1] = d[idx+2] = 0;
            d[idx+3] = Math.round(v * 255);
          }
          mctx.putImageData(imgData, 0, 0);
          drawn = true;
        }
      }

      // 4) Смягчение края
      const feather = parseFloat(featherInput.value);
      if (drawn && feather > 0) featherMask(feather);

      // 5) Окраска
      if (drawn) {
        const { r, g, b } = hexToRgb(colorInput.value);
        mctx.globalCompositeOperation = 'source-in';
        mctx.globalAlpha = 1;
        mctx.fillStyle = `rgb(${r},${g},${b})`;
        mctx.fillRect(0, 0, width, height);

        // 6) Блендинг поверх
        ctx.globalCompositeOperation = blendSelect.value; // color/overlay/…
        ctx.globalAlpha = parseFloat(strengthInput.value);
        ctx.drawImage(maskCanvas, 0, 0, width, height);

        ctx.globalCompositeOperation = 'source-over';
        ctx.globalAlpha = 1;
      }

      requestAnimationFrame(processFrame);
    }

    snapBtn.addEventListener('click', () => {
      const url = out.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url;
      a.download = 'hair-snapshot.png';
      a.click();
    });

    swapBtn.addEventListener('click', async () => {
      currentFacing = currentFacing === 'user' ? 'environment' : 'user';
      await initCamera();
    });

    (async function start() {
      try {
        setStatus('Инициализация…');

        // 2) Если UMD не успел — пробуем ESM-фолбэк и пробрасываем глобалы
        try { await untilMPReady(); }
        catch {
          const mod = await import('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/vision_bundle.mjs');
          window.FilesetResolver = mod.FilesetResolver;
          window.ImageSegmenter  = mod.ImageSegmenter;
        }

        await initCamera();
        video.addEventListener('loadedmetadata', resizeToVideo, { once: true });

        setStatus('Загрузка модели…');
        await initSegmenter();

        setStatus('Готово');
        requestAnimationFrame(processFrame);
      } catch (e) {
        console.error(e);
        setStatus('Ошибка: ' + (e && e.message ? e.message : e));
        alert('Ошибка при запуске демо:\n' + e);
      }
    })();
  </script>
</body>
</html>
